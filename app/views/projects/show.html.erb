<div i class=""id="page-wrapper">
  <div class="row">
  <div class="col-lg-12">
    <h1><%= @project.name %> <small>Organisation</small></h1>
    <ol class="breadcrumb">
      <li><%= link_to '<i class="fa fa-dashboard"></i> Dashboard'.html_safe , root_path %></li>
      <li><%= link_to '<i class="fa fa-clipboard"></i> Meine Projekte'.html_safe , projects_path %></li>
      <li class="active"><i class="fa fa-clipboard"></i> <%= @project.name %></li>
      <span class="pull-right"><a class="text-weak"><i class="fa fa-gear"></i></a></span>
    </ol>
    
  </div>
</div>
		<!-- Display all user who are added the current in the project -->
		<div class="well well-lg">
			<% @users = User.joins(:projects).where("project_id == ?", @project.id) %>
			
			<% @users.each_with_index do |user| %>
				<%= image_tag avatar_url(user, 15) %>
				<%= user.id %>
				<%= user.firstname %>
				<%= user.lastname %>
			<% end %>
			
			
		<!-- add a new user to the project -->
		<%= form_tag project_add_user_path(@project.id) do %>
			<%= text_field_tag :user_email, nil, :placeholder => 'Email' %>
			<%= submit_tag "Add", :class=>'btn btn-primary'%>
		<% end %>
		</div>
          
          
       <%# Show Lists and Tasks %>
      <div class="row">
      
        <%# counter for css style elements in the loop %>
		<% n = 0 %>
		

        <% @lists.each do |list| %>	
      
        <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
        <div class="well well-lg">

        <%= link_to '<i class="fa fa-arrow-circle-left"></i>'.html_safe, list_move_down_path(:list_id => list), :method => :POST if list != @lists.first %>
			  <%= link_to '<i class="fa fa-arrow-circle-right"></i>'.html_safe, list_move_up_path(:list_id => list), :method => :POST if list != @lists.last %>
          
	      <h4> <strong class="list-title" onClick = "updateList(this, <%= list.id%>);"><%= list.name %></strong>
            <a onClick = "toggleList(this, <%= list.id %>)"><i class="fa fa-caret-square-o-down"></i></a>
			      

            <div class="dropdown pull-right">
              <button class="btn dropdown-toggle" type="button" data-toggle="dropdown"><span class="fa fa-bars"></span></button>
              <ul class="dropdown-menu" role="menu">
                <li role="presentation"><%= link_to 'Aufgabe anlegen', project_list_tasks_path(@project, list), :method =>:post %></li>
                <li role="presentation" class="divider"></li>
                <li role="presentation"><%= link_to 'Liste löschen <i class="fa fa-exclamation-circle"></i>'.html_safe, project_list_path(project_id:@project, list_id:list), method: :delete, :confirm => "Soll die Liste wirklich gelöscht werden?" %></li>
              </ul>
            </div>
          </h4>
          <br/>
          <% @tasks = Task.where("list_id = ?",  list.id).order("position DESC") %>
          
          <% @tasks.each do |task| %>
          
          <!-- Drag & Drop target -->
          <div  id = "position<%= task.position %>" ondrop="drop(event)" class="panel panel-default" ondragenter="drag_enter(event, <%=list.id%>)" ></div>
          
          <div class="panel panel-default <%= list.id %>" draggable="true" ondragstart="drag(event, <%= task.position %>, <%=list.id%>)" >
            <div class="panel-heading">
              
             <!-- get the assigned user for the dropdown/default value -->
             <% @user = User.joins(:tasks).where("task_id == ?", task.id).first %> 
             <% if @user.present?
					@user_name = @user.firstname
					@task_user_id = @user.id
				else
					@user_name = ""
					@task_user_id = -1
				end %>  
				
             <a class ="task_modal" data-toggle="modal" data-id = "666" onClick = "updateTask(<%= task.id %>, '<%= task.titel %>','<%= task.text %>', '<%= @task_user_id %>');"><strong><%= task.titel %></strong></a>
             
             <%# Let the Task move up and down in list %>
             <%= link_to '<i class="fa fa-arrow-circle-down"></i>'.html_safe, project_task_move_down_path(@project, :task_id => task), :method => :GET if task != @tasks.last %>
             <%= link_to '<i class="fa fa-arrow-circle-up"></i>'.html_safe, project_task_move_up_path(@project, :task_id => task), :method => :GET if task != @tasks.first %>
			      <!-- Hübschere Darstellungsform -->  
            <%=@user_name%>
			 
             <%= link_to '&times;'.html_safe, project_list_task_path(project_id:@project, list_id:list, task_id:task), method: :delete, :class => "close pull-right", :confirm => "Soll die Aufgabe wirklich gelöscht werden?" %>
          
            </div>
            <div class="panel-body">
              <%= task.text %>
              <br/>
              <br>
              <small class="text-weak">   <i class="fa fa-clock-o"></i> Endet in <%= distance_of_time_in_words(Time.now, Time.now) %></small>
              <br/>
              <%= link_to '<i class="fa fa-arrow-circle-left"></i>'.html_safe, project_task_move_to_prev_list_path(project_id:@project.id, task_id:task.id) if task.list != @lists.first %>
			  <%= link_to '<i class="fa fa-arrow-circle-right"></i>'.html_safe, project_task_move_to_next_list_path(project_id:@project.id, task_id:task.id) if task.list != @lists.last %>
            </div>
          </div>
          
          <% end %>
          
        <!-- last Drag&Drop position -->
		<div  id = "position0" ondrop="drop(event)" class="panel panel-default" ondragenter="drag_enter(event, <%=list.id%>)" ></div>
      
 
        </div>

      </div>
        
        <% if (n+1)%2 == 0 %>
			<div class="clearfix visible-sm"></div>
        <% end %>
        
		<% if (n+1)%3 == 0 %>
			<div class="clearfix visible-md"></div>
        <% end %>
        
        <% if (n+1)%4 == 0 %>
			<div class="clearfix visible-lg"></div>
		<% end %>
        
        <% n = n+1%>
      
        <% end %>
          <div class="col-xs-12 col-sm-6 col-md-4 col-lg-3">
			<div class="well well-lg">
				<h4><strong><%= link_to 'Neue Liste anlegen...',  project_lists_path(@project), :method => :POST %></strong></h4>
			</div>
          </div>
		</div>
    <hr>
  <%= link_to 'Projekt löschen', project_path(:project_id => @project), method: :delete, :confirm => "Soll das Projekt wirklich gelöscht werden?", :class => 'btn btn-danger' %>
  <br/>
  <br/ >
  <%= link_to 'Zurück zur Projektübersicht', projects_path, :class => 'btn btn-default' %>
</div>

<!-- Task-Modal -->
         
          <div class="modal fade" id="editTaskModal" tabindex="-1" role="dialog" aria-labelledby="editTaskModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <%= form_tag project_task_path(@project.id, 0), :method => :put, :html => {:class => 'form-inline'} do %>
                <%= hidden_field_tag 'task_id', NIL, {:class => 'form-control'} %>
                <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                  <h4 class="modal-title" id="editTaskModalLabel"><%= text_field_tag :titel, NIL, {:class => 'form-control', :id=> 'task_titel'} %></h4>
                  Zuweisen an:<%= select_tag "user_id", options_from_collection_for_select(@users, "id", "firstname"), include_blank: true, :class => "form-control" %>
                </div>
                <div class="modal-body">
                 
                 <%# Add Task %>
				 <div class="form-group"> 
					   <%= text_area_tag :text, NIL, {:size => "100x3", :class => 'form-control', :id=> 'task_text'} %>
					  
                </div>
       

       

                <div class="modal-footer">
                  <%= submit_tag "Speichern", :class => 'btn btn-primary' %>
                  <% end %>        
                  <button type="button" class="btn btn-default" data-dismiss="modal">Abbrechen</button>
                </div>
              </div><!--/.modal-content -->
            </div><!-- /.modal-dialog -->
          </div><!-- /.modal -->

 
